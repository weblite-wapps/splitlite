<template>
<div :class="$style['add-trans']">
  <div :class="$style['inputs']"> 
      <div :class="$style['title']">
        <span :class="$style['title-label']"> Title : </span>
        <input :class="$style['title-input']" v-model="title"/>
      </div>
      <div :class="$style['sources']">
          <div :class="$style['section-label']"> Sources : </div>
          <div :class="$style['input-items']">
            <div v-for="(source, index) in sources" :key="index" :class="$style['input-item']">
                <div :class="$style['user-select']"> 
                    <select v-model="sources[index].user">
                        <option
                        v-for="(user, selectIndex) in users" 
                        :value="user"
                        :key="selectIndex">
                            {{ user }}
                        </option>
                    </select>
                </div>
                <div :class="$style['value-input']">
                    <input v-model="sources[index].value" type="number"/>
                </div>
            </div>
            <div :class="$style['add-user']">
                <i @click="addSource()"> add </i>
            </div>
          </div>
      </div>
      <div :class="$style['targets']">
          <div :class="$style['section-label']"> Targets : </div>
          <div :class="$style['input-items']">
            <div v-for="(target, index) in targets " :key="index" :class="$style['input-item']">
                <div :class="$style['user-select']"> 
                    <select v-model="targets[index].user">
                        <option
                        v-for="(user, selectIndex) in users" 
                        :value="user"
                        :key="selectIndex">
                            {{ user }}
                        </option>
                    </select>
                </div>
                <div :class="$style['value-input']">
                    <input v-model="targets[index][curTargetProperty]" type="number" :readonly="splitType === 'equally'"/>
                </div>
            </div>
            <div :class="$style['add-user']">
                <i @click="addTarget()"> add </i>
            </div>
          </div>
      </div>

      <div :class="$style['type-section']">
          <span :class="$style['split-caption']"> split type : </span>
          <div :class="$style['types']">
            <div :class="$style['split-type']"> 
                <input type="radio" id="equally" value="equally" v-model="splitType"/> Equally 
            </div>
            <div :class="$style['split-type']"> 
                <input type="radio" id="unequally" value="unequally" v-model="splitType"/> Unequally
            </div>
          </div>
      </div>
  </div>

  <add-button v-if="warning.show === false" label="Add"/>
  <div v-else :class="$style['warning']">
    <span> <i> warning </i> </span>
    <span :class="$style['warning-text']"> {{ warning.msg }} </span>
  </div>
</div>
</template>


<script>
// components
import AddButton from '../helper/components/AddButton.vue'
// W
const { R } = window


export default {
  name: 'AddTrans',
  props: ['users'],
  components: {
    AddButton
  },
  data: () => ({
    sources: [], // {user, value}
    targets: [], // {user, value, equalValue}

    title: 'Weblite Lunch',
    splitType: 'equally'
  }),
  watch: {
      sumOfSources () {
        this.targets = this.targets.map(target => ({
            user: target.user,
            value: target.value, 
            equalValue: this.sumOfSources / this.targets.length}))
      },
  },
  computed: {
      warning() {
          if (this.title.trim() === '') 
              return ({show: true, msg: 'Enter transaction title!'})
          if (this.splitType === 'unequally' && this.sumOfSources != this.sumOfTargets)
              return ({show: true, msg: 'Sum of sources and targets are not equal !'})
          return ({show: false, msg: ''})
      },
      sumOfSources() {
          return R.sum(R.map(source => source.value, this.sources))
      },
      sumOfTargets() {
          return R.sum(R.map(target => target.value, this.targets))
      },
      curTargetProperty() {
          return (this.splitType === 'unequally') ? 'value' : 'equalValue' 
      },
      resultTrans() {
        let uniqueSources = R.filter(source => source.value != 0, R.map(name => ({ user: name,
        value: R.sum(R.map(user => user.value, R.filter(src => src.user == name, this.sources)))
        }), this.users))
    
        let uniqueTargets = R.filter(target => target.value != 0, R.map(name => ({ user: name,
        value: R.sum(R.map(user => user[this.curTargetProperty], R.filter(tar => tar.user == name, this.targets)))
        }), this.users))

        R.forEach(src => {
            const srcIndex = R.findIndex(source => source.user == src.user, uniqueSources)
            const tarIndex = R.findIndex(target => target.user == src.user, uniqueTargets)
            
            if (srcIndex >= 0 && tarIndex >= 0) {
                if (uniqueSources[srcIndex].value >= uniqueTargets[tarIndex].value) {
                    uniqueSources[srcIndex].value -= uniqueTargets[tarIndex].value
                    uniqueTargets[tarIndex].value = 0
                } else {
                    uniqueTargets[tarIndex].value -= uniqueSources[srcIndex].value
                    uniqueSources[srcIndex].value = 0
                }
            }
        }, uniqueSources)

        const finalSources = R.filter(source => source.value != 0, uniqueSources)
        const finalTargets = R.filter(target => target.value != 0, uniqueTargets)
        const sumOfFinalSources = R.sum(R.map(src => src.value, finalSources))

        let payments = []
        R.forEach(target => {
            const ownings = R.map(src => ({from: target.user, to: src.user, value: src.value / sumOfFinalSources * target.value}), finalSources)
            payments = R.insertAll(0, ownings, payments)
        }, finalTargets)
        
        return ({
            title: this.title,
            sources: finalSources,
            payments: payments 
        })

      }
  },
  methods: {
      addSource() {
          if (this.users.length > 0)
            this.sources.push( {user: this.users[0], value: 0} )
      },
      addTarget() {
          if (this.users.length > 0) {
            if (this.splitType === 'equally') {
              this.targets = this.targets.map(target => ({user: target.user, value: target.value, equalValue: this.sumOfSources / (this.targets.length + 1)}))
              this.targets.push( {user: this.users[0], value: 0, equalValue: this.sumOfSources / (this.targets.length + 1)} )
            }
            else
              this.targets.push( {user: this.users[0], value: 0, equalValue: 0} )
          }
      },
      addTrans() {
          const transObj = this.resultTrans
          // send trans to the server
      }
  }
}
</script>


<style module>
.add-trans {
  width: 350px;
  height: 100%;
  display: flex;
  flex-direction: column;

  align-items: flex-start;
  align-content: space-around;

  overflow-x: hidden;
  overflow-y: scroll;

  background: lightgray;
}

.inputs {
  width: 350px;
  height: 100%;
  display: flex;
  flex-direction: column;

  align-items: center;
  align-content: space-around;

  overflow: hidden;

  background: rgb(73, 73, 73);
}

.warning {
  width: 350px;
  min-height: 50px;

  display: flex;
  flex-direction: row;
  
  align-items: center;

  background: #e42b2b;
  color: white;

  padding: 0 15px;
}

.warning-text {
  max-width: 250px;
  padding-left: 15px;
}

::-webkit-scrollbar {
  display: none;
}

.title {
  width: 330px;
  min-height: 40px;

  color: white;

  border: none;
  border-bottom: 1px rgba(143, 143, 143, 0.637) solid;

  display: flex;
  flex-direction: row;
  align-items: center;

  margin: 10px;
  padding-bottom: 2px;
}

.title-input {
  width: 272px;
  margin-left: 10px;
}

.sources {
  width: 330px;
  min-height: 35%;
  max-height: 35%;

  color: white;
  border: none;
  border-bottom: 1px rgba(143, 143, 143, 0.637) solid;

  display: flex;
  flex-direction: column;

  margin-bottom: 10px;

  overflow: scroll;
}

.targets {
  width: 330px;
  min-height: 43%;
  max-height: 43%;

  color: white;
  border: none;
  border-bottom: 1px rgba(143, 143, 143, 0.637) solid;

  display: flex;
  flex-direction: column;

  margin-bottom: 10px;
}

.section-label {
    margin-bottom: 5px;
}

.input-items {
  max-height: inherit;
  min-height: inherit;

  display: flex;
  flex-direction: column;

  align-items: center;
}

.input-item {
  width: 300px;
  min-height: 25px;

  display: flex;
  flex-direction: row;

  align-items: center;
  justify-content: space-around;
  margin: 5px 0;
}

.add-user {
  color: rgb(230, 172, 96);
  margin-bottom: 5px;
}

.type-section {
  width: 330px;
  min-height: 40px;

  color: white;

  display: flex;
  flex-direction: row;

  margin-bottom: 10px;
}

.split-type {
    margin-left: 10px;
}

</style>
